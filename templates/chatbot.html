<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSens AI Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .chatbot-container { max-width: 600px; margin: 120px auto 40px; background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); padding: 2rem; }
        .chat-title { font-size: 1.5rem; font-weight: 700; color: #2d5016; margin-bottom: 1rem; }
        .chat-window { height: 320px; overflow-y: auto; background: #f0f7f0; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .chat-msg { margin-bottom: 1rem; }
        .chat-msg.user { text-align: right; color: #4CAF50; }
        .chat-msg.bot { text-align: left; color: #333; }
        .chat-input-row { display: flex; gap: 0.5rem; }
        .chat-input { flex: 1; padding: 0.75rem 1rem; border-radius: 8px; border: 1px solid #ddd; }
        .chat-send-btn { background: #4CAF50; color: #fff; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; font-weight: 600; cursor: pointer; }
        .chat-send-btn:hover { background: #45a049; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-icon">ðŸŒ¾</span>
                <span class="logo-text">AgriSens</span>
            </div>
            <ul class="nav-menu">
                <li class="dropdown">
                    <a href="#product" class="dropbtn">Product â–¼</a>
                    <div class="dropdown-content">
                        <a href="{{ url_for('weather') }}">Weather Forecast</a>
                        <a href="{{ url_for('disease') }}">Plant Disease Identification</a>
                        <a href="{{ url_for('crop') }}">Crop Recommendation</a>
                        <a href="{{ url_for('chatbot') }}">AI Chatbot</a>
                    </div>
                </li>
                <li><a href="#solution">Solution</a></li>
                <li><a href="#resources">Resources</a></li>
                <li><a href="#pricing">Pricing</a></li>
                <li><a href="#about">About</a></li>
            </ul>
            <button class="contact-btn">Contact Us â†’</button>
        </div>
    </nav>
    <div class="chatbot-container">
        <div class="chat-title">AgriSens AI Chatbot</div>
        <div class="chat-window" id="chat-window"></div>
        <form class="chat-input-row" id="chat-form" autocomplete="off">
            <input type="text" class="chat-input" id="chat-input" placeholder="Ask about your plants..." required>
            <button type="submit" class="chat-send-btn">Send</button>
        </form>
    </div>
    <script>
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        function appendMessage(text, sender, isHtml=false) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-msg ' + sender;
            if (isHtml) {
                msgDiv.innerHTML = text;
            } else {
                msgDiv.textContent = text;
            }
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        let loadingInterval = null;
        let loadingTimeouts = [];
        const loadingMessages = [
            { text: 'Thinking...', duration: 5000 },
            { text: 'Gathering Content...', duration: 3000 },
            { text: 'Analysing...', duration: 2000 }
        ];
        function startLoadingMessages() {
            // Remove any previous loading messages
            stopLoadingMessages();
            // Show 'Thinking...' for 5s, then 'Gathering Content...' for 3s, then 'Analysing...' for 2s
            let idx = 0;
            function showNext() {
                // Remove last loading message if present
                if (chatWindow.lastChild && chatWindow.lastChild.classList.contains('bot')) {
                    chatWindow.lastChild.remove();
                }
                appendMessage(loadingMessages[idx].text, 'bot');
                if (idx < loadingMessages.length - 1) {
                    loadingTimeouts.push(setTimeout(() => {
                        idx++;
                        showNext();
                    }, loadingMessages[idx].duration));
                } else {
                    // After last message, keep showing 'Analysing...' until stopped
                    loadingTimeouts.push(setTimeout(() => {
                        showNext();
                    }, loadingMessages[idx].duration));
                }
            }
            showNext();
        }
        function stopLoadingMessages() {
            // Clear all timeouts
            loadingTimeouts.forEach(t => clearTimeout(t));
            loadingTimeouts = [];
            // Remove last loading message if present
            if (chatWindow.lastChild && chatWindow.lastChild.classList.contains('bot')) {
                chatWindow.lastChild.remove();
            }
        }

        chatForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const userMsg = chatInput.value.trim();
            if (!userMsg) return;
            appendMessage(userMsg, 'user');
            chatInput.value = '';
            startLoadingMessages();
            const res = await fetch('/chatbot_api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: userMsg })
            });
            const data = await res.json();
            stopLoadingMessages();
            appendMessage(data.reply, 'bot', true);
        });
    </script>
</body>
</html>
